# Модуль 9. Урок 55. Введение в авторизацию пользователей в Django

## Зачем сайту нужна авторизация

Большинство реальных веб-приложений работают не только с контентом, но и с пользователями.
В проекте **cinemahub** это особенно важно:

* одни пользователи просто просматривают каталог фильмов;
* другие могут добавлять фильмы, редактировать описания, управлять тегами и жанрами;
* администраторы модерируют контент и управляют системой.

Чтобы реализовать такую логику, Django использует **систему пользователей**, основанную на трех ключевых понятиях: аутентификация, авторизация и сессии.

---

## Базовые понятия: аутентификация, авторизация, сессии

Перед тем как писать код, важно четко разделять эти термины.

### Аутентификация (Authentication)

Аутентификация — это процесс **проверки личности пользователя**.
На практике это означает:

* пользователь вводит логин и пароль;
* Django проверяет, существует ли такой пользователь;
* сверяет введённый пароль с хешем в базе данных.

Если данные верны — пользователь считается **аутентифицированным**.

---

### Авторизация (Authorization)

Авторизация отвечает на вопрос:
**что именно может делать аутентифицированный пользователь?**

Примеры в контексте cinemahub:

* можно ли пользователю добавлять новые фильмы;
* может ли он редактировать существующие Movie;
* имеет ли доступ к админ-панели.

Авторизация всегда работает **после** аутентификации.

---

### Сессии (Sessions)

HTTP — протокол без состояния. После каждого запроса сервер «забывает» клиента.
Чтобы этого не происходило, Django использует **сессии**.

Упрощённо процесс выглядит так:

1. Пользователь успешно входит в систему.
2. Django сохраняет идентификатор пользователя в сессии.
3. В браузер отправляется cookie с ID сессии.
4. При каждом следующем запросе Django понимает, **кто именно** отправил запрос.

---

## Встроенная система пользователей Django

Одно из ключевых преимуществ Django — готовая система работы с пользователями.
Она подключается автоматически при создании проекта.

### Таблица `auth_user`

После выполнения миграций Django создает таблицу `auth_user`.
В ней хранятся основные данные пользователя:

* `username` — имя пользователя (логин)
* `password` — **хешированный** пароль
* `email` — электронная почта
* `is_active` — активен ли аккаунт
* `is_staff` — доступ к админ-панели
* `is_superuser` — полный доступ ко всем действиям

Важно: **Django никогда не хранит пароль в открытом виде**.

---

### Вспомогательные таблицы

Помимо `auth_user`, создаются и другие таблицы:

* `auth_permission` — список разрешений;
* `auth_group` — группы пользователей;
* `django_session` — данные активных сессий.

Позже мы будем активно использовать разрешения и группы, но пока ограничимся базовой структурой.

---

## Создание приложения users

Для логичного разделения кода всю работу с пользователями мы будем хранить в отдельном приложении `users`.

### Шаг 1. Создание приложения

Выполните команду в терминале:

```bash
python manage.py startapp users
```

В проекте появится папка `users/`.

---

### Шаг 2. Подключение приложения

Откройте файл **`settings.py`** и добавьте приложение в `INSTALLED_APPS`:

```python
INSTALLED_APPS = [
    ...
    "users.apps.UsersConfig",
]
```

---

### Шаг 3. Проверка middleware

Для работы авторизации Django использует middleware.
Убедитесь, что в `settings.py` присутствуют строки:

```python
MIDDLEWARE = [
    ...
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    ...
]
```

Если одного из них нет — авторизация работать не будет.

---

## Маршруты приложения users

Пока мы не реализуем реальную логику входа и выхода, но подготовим структуру.

### Файл `users/urls.py`

Создайте файл **`users/urls.py`** и добавьте в него:

```python
from django.urls import path
from . import views

app_name = "users"

urlpatterns = [
    path("login/", views.login_user, name="login"),
    path("logout/", views.logout_user, name="logout"),
]
```

Обратите внимание на `app_name`.
Он позволит обращаться к маршрутам как `users:login`.

---

### Представления users

Откройте файл **`users/views.py`** и добавьте временные обработчики:

```python
from django.http import HttpResponse

def login_user(request):
    return HttpResponse("Страница входа в систему")

def logout_user(request):
    return HttpResponse("Выход из системы")
```

На этом этапе они ничего не делают — это нормально.
Мы используем их как «заглушки».

---

## Подключение маршрутов users к проекту

Теперь нужно подключить маршруты приложения к основному роутеру проекта.

Откройте **`cinemahub/urls.py`**:

```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path("admin/", admin.site.urls),
    path("", include("movies.urls")),
    path("users/", include("users.urls", namespace="users")),
]
```

---

## Проверка результата в браузере

Запустите сервер:

```bash
python manage.py runserver
```

Откройте браузер и перейдите по адресам:

* `http://127.0.0.1:8000/users/login/`
* `http://127.0.0.1:8000/users/logout/`

Если вы видите текстовые сообщения — значит:

* приложение `users` подключено корректно;
* маршрутизация работает;
* Django готов к дальнейшей настройке авторизации.

---

## Типичные ошибки и их причины

### Ошибка 404 при переходе на `/users/login/`

Причины:

* не подключили `users.urls` в главном `urls.py`;
* опечатка в пути (`users/`, `user/`, `login`).

---

### Ошибка `NoReverseMatch`

Причины:

* забыли указать `app_name = "users"`;
* неверно используете namespace при обращении к URL.

---

### Авторизация не работает в будущем

Частая причина — удалён или закомментирован `AuthenticationMiddleware`.

---

## Практические задания

### Задание 1

Создайте в приложении `users` маршрут `/users/profile/`, который возвращает сообщение
`Профиль пользователя`.

**Требования:**

* маршрут должен находиться в `users/urls.py`;
* представление — в `users/views.py`.

---

### Задание 2

Добавьте маршрут `/users/check/`, который возвращает текст
`Система авторизации подключена`.

---

### Задание 3

Подключите namespace и попробуйте получить URL маршрута `users:login` через `reverse()` в Django shell.

---

## Сравнить решение

### Решение задания 1

`users/views.py`:

```python
def profile(request):
    return HttpResponse("Профиль пользователя")
```

`users/urls.py`:

```python
path("profile/", views.profile, name="profile"),
```

---

### Решение задания 2

```python
def check_auth(request):
    return HttpResponse("Система авторизации подключена")
```

---

### Решение задания 3

```bash
python manage.py shell
```

```python
from django.urls import reverse
reverse("users:login")
```

---

## Вопросы для самопроверки

1. В чём разница между аутентификацией и авторизацией?
2. Для чего Django использует сессии?
3. Какая таблица хранит пользователей по умолчанию?
4. Зачем нужен `AuthenticationMiddleware`?
5. Почему пароли в Django нельзя прочитать в базе данных?
6. Для чего используется `app_name` в `urls.py`?
7. Где подключаются маршруты приложения к проекту?
8. Что произойдёт, если удалить `SessionMiddleware`?

---

[Предыдущий урок](lesson54.md) | [Следующий урок](lesson56.md)